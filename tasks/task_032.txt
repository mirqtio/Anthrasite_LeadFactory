# Task ID: 32
# Title: Full E2E BDD Pipeline Validation Including Real Email Delivery
# Status: done
# Dependencies: None
# Priority: high
# Description: Implement and execute an end-to-end test of the entire Phase 0 pipeline using real API keys and production configuration to validate that leads can be processed fully, including mockup generation and email delivery via SendGrid.
# Details:
This task involves setting up and running a comprehensive end-to-end test of the entire lead processing pipeline with real credentials:

1. Configure `.env.e2e` with all real API keys, including a controlled email override address (EMAIL_OVERRIDE=charlie@anthrasite.io).

2. Modify the email sending logic in `06_email_queue.py` or equivalent to implement the EMAIL_OVERRIDE functionality:
   ```python
   # Add to email sending logic
   if os.getenv("EMAIL_OVERRIDE"):
       original_recipient = recipient_email
       recipient_email = os.getenv("EMAIL_OVERRIDE")
       logger.info(f"EMAIL_OVERRIDE active: Redirecting email from {original_recipient} to {recipient_email}")
   ```

3. Ensure the pipeline can run with MOCKUP_ENABLED=true and process a real zip code + vertical input.

4. Enable the SendGrid integration to send actual emails using the override address.

5. Add a new BDD scenario in the appropriate feature file:
   ```gherkin
   Scenario: Full lead processed and email delivered
     Given a test lead is queued
     When the pipeline runs with real API keys
     Then a screenshot and mockup are generated
     And a real email is sent via SendGrid to EMAIL_OVERRIDE
     And the SendGrid response is 202
   ```

6. Implement a logging mechanism that writes a summary of the E2E test to `e2e_summary.md`, including:
   - Number of leads processed
   - API costs incurred
   - Paths to generated screenshots/mockups
   - Preview of the email body content
   - SendGrid message ID

7. Ensure the test validates:
   - Email content includes correct mockup
   - Personalization is applied correctly
   - CAN-SPAM footer is present and valid
   - SendGrid API returns a 202 status code
   - A row is written to the emails table with appropriate variant and message ID
   - The test email is received at the override address

This task should be executed locally or manually, not in the CI environment which should continue to run in mock mode.

# Test Strategy:
1. Set up the test environment:
   - Create a `.env.e2e` file with all required real API keys
   - Configure EMAIL_OVERRIDE=charlie@anthrasite.io
   - Ensure access to the override email inbox for verification

2. Execute the full pipeline test:
   - Run the pipeline with `MOCKUP_ENABLED=true` and real API keys
   - Monitor the execution logs for any errors or warnings

3. Verify email delivery:
   - Check the override email inbox for the test email
   - Confirm the email contains the correct mockup image
   - Verify personalization elements are correctly applied
   - Ensure the CAN-SPAM footer contains the required information
   - Validate that unsubscribe links are functional

4. Validate database and API responses:
   - Confirm the emails table has a new entry for the test lead
   - Verify the SendGrid API response shows a 202 status code
   - Check that the message ID is properly recorded

5. Review the generated e2e_summary.md file:
   - Confirm it contains all required information
   - Verify API costs are within expected ranges
   - Check that all file paths to assets are valid

6. Run the BDD test:
   - Execute `pytest` with the new BDD scenario
   - Confirm the test passes all assertions

7. Document any issues or observations for future improvements to the pipeline.

# Subtasks:
## 1. Configure E2E Environment with Real API Keys [done]
### Dependencies: None
### Description: Set up the .env.e2e file with all necessary production API keys and configure the EMAIL_OVERRIDE functionality to safely test email delivery.
### Details:
Create or update .env.e2e with real API keys for all services (SendGrid, etc.). Add EMAIL_OVERRIDE=charlie@anthrasite.io to redirect all test emails. Ensure MOCKUP_ENABLED=true is set. Document all API keys being used and their associated services in a secure location.

## 2. Implement Email Override Functionality [done]
### Dependencies: 32.1
### Description: Modify the email sending logic in 06_email_queue.py to implement the EMAIL_OVERRIDE functionality that redirects emails to a controlled address.
### Details:
Add logic to check for EMAIL_OVERRIDE environment variable before sending emails. If present, log the original recipient and redirect to the override address. Ensure this change doesn't affect production behavior when the variable isn't set. Update the SendGrid integration to use this modified recipient.

## 3. Create BDD Scenario for E2E Pipeline Validation [done]
### Dependencies: 32.2
### Description: Add a new BDD scenario in the appropriate feature file to test the full lead processing pipeline including email delivery.
### Details:
Create a scenario that tests a lead being processed through the entire pipeline with real API keys. Include steps to verify screenshot generation, mockup creation, email sending via SendGrid, and validation of the SendGrid response code. Use the Gherkin syntax as specified in the task description.

## 4. Implement E2E Test Logging and Summary Generation [done]
### Dependencies: 32.3
### Description: Create a logging mechanism that captures detailed information about the E2E test execution and generates a summary report.
### Details:
Implement a logger that tracks the entire E2E process. Write a function to generate an e2e_summary.md file containing: number of leads processed, API costs incurred, paths to generated assets, preview of email content, and SendGrid message IDs. Format the summary with markdown for readability.

## 5. Execute and Validate Full E2E Test [done]
### Dependencies: 32.4
### Description: Run the complete E2E test with real credentials and validate all aspects of the pipeline including email delivery and content.
### Details:
Execute the BDD scenario with the E2E environment. Verify that: emails are delivered to the override address, email content includes the correct mockup, personalization is applied correctly, CAN-SPAM footer is present, SendGrid returns 202 status, and a row is written to the emails table with appropriate data. Document any issues encountered during testing.

